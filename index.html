<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Batch Metadata - Fixed Version</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f1f5f9; --card: #ffffff; --dark: #0f172a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 1000px; margin: auto; background: var(--card); border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--primary); background: rgba(255,255,255,0.05); }

        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }

        .api-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .main-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; margin-top: 10px; }
        
        .drop-zone { border: 3px dashed #cbd5e1; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; }
        .img-mini { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }

        .result-item { border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 20px; border-radius: 8px; background: #fff; }
        .result-grid { display: grid; gap: 15px; margin-top: 15px; }
        .data-field { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #edf2f7; position: relative; }
        .data-label { font-size: 11px; font-weight: bold; color: #64748b; text-transform: uppercase; }
        
        .copy-btn { float: right; background: #64748b; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .pending { background: #f1f5f9; }
        .loading { background: #dbeafe; color: #1e40af; }
        .done { background: #dcfce7; color: #166534; }
        .error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="btn0" onclick="goToTab(0)">1. API SETUP</button>
        <button class="tab-btn" id="btn1" onclick="goToTab(1)">2. UPLOAD</button>
        <button class="tab-btn" id="btn2" onclick="goToTab(2)">3. PROSES</button>
        <button class="tab-btn" id="btn3" onclick="goToTab(3)">4. HASIL</button>
    </div>

    <div id="tab0" class="tab-content active">
        <h2>Setup Groq Cloud API</h2>
        <div class="api-box">
            <input type="password" id="apiKeyInput" placeholder="Masukkan API Key (gsk_...)" style="width:100%; padding:12px; border-radius:6px; border:1px solid #ccc;">
            <p><a href="https://console.groq.com/keys" target="_blank" style="color:var(--primary);">Dapatkan API Key di sini (Gratis)</a></p>
        </div>
        <button class="main-btn" onclick="saveKey()">Simpan & Mulai</button>
    </div>

    <div id="tab1" class="tab-content">
        <h2>Pilih Foto</h2>
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <strong>Klik untuk pilih banyak foto</strong>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="loadFiles(this.files)">
        </div>
        <div id="fileCount" style="margin-top:15px; font-weight:bold;"></div>
        <button class="main-btn" id="btnToTab2" style="display:none" onclick="goToTab(2)">Lanjut ke Pemrosesan</button>
    </div>

    <div id="tab2" class="tab-content">
        <h2>Proses Identifikasi</h2>
        <button class="main-btn" id="startBtn" onclick="processAll()">Mulai Generate Sekarang</button>
        <table>
            <thead><tr><th>Preview</th><th>Nama File</th><th>Status</th></tr></thead>
            <tbody id="queueList"></tbody>
        </table>
    </div>

    <div id="tab3" class="tab-content">
        <h2>Hasil Metadata AI</h2>
        <div id="resultsList"></div>
        <button class="main-btn" style="background:#64748b" onclick="location.reload()">Bersihkan & Ulangi</button>
    </div>
</div>

<script>
    let filesData = [];

    function goToTab(i) {
        document.querySelectorAll('.tab-content').forEach((t, idx) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, idx) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const k = document.getElementById('apiKeyInput').value;
        if(k.includes('gsk_')) {
            localStorage.setItem('groq_key', k);
            alert("API Key Tersimpan!");
            goToTab(1);
        } else {
            alert("Masukkan API Key yang valid!");
        }
    }

    // Auto-load key
    if(localStorage.getItem('groq_key')) document.getElementById('apiKeyInput').value = localStorage.getItem('groq_key');

    function loadFiles(files) {
        filesData = [];
        const list = document.getElementById('queueList');
        list.innerHTML = "";
        
        Array.from(files).forEach((file, i) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                filesData.push({
                    id: i,
                    name: file.name,
                    base64: e.target.result.split(',')[1],
                    preview: e.target.result,
                    status: 'pending'
                });
                list.innerHTML += `<tr id="row-${i}">
                    <td><img src="${e.target.result}" class="img-mini"></td>
                    <td>${file.name}</td>
                    <td><span id="st-${i}" class="status-badge pending">Menunggu</span></td>
                </tr>`;
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('fileCount').innerText = files.length + " File dipilih";
        document.getElementById('btnToTab2').style.display = "block";
    }

    async function processAll() {
        const key = localStorage.getItem('groq_key');
        if(!key) return alert("API Key hilang!");
        
        document.getElementById('startBtn').disabled = true;
        const resultsList = document.getElementById('resultsList');
        resultsList.innerHTML = ""; // Reset hasil

        for(let item of filesData) {
            const st = document.getElementById(`st-${item.id}`);
            st.innerText = "Memproses...";
            st.className = "status-badge loading";

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.2-11b-vision-preview",
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: "Create Microstock Metadata. Return JSON with 'title', 'description', and 'keywords' (list of 60 words). No technical terms (4k, uhd). English only." },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }
                            ]
                        }],
                        response_format: { type: "json_object" }
                    })
                });

                const json = await res.json();
                const aiResult = JSON.parse(json.choices[0].message.content);
                const final = cleanMetadata(aiResult);
                
                renderResult(item, final);
                
                st.innerText = "Berhasil";
                st.className = "status-badge done";
            } catch (err) {
                console.error(err);
                st.innerText = "Error!";
                st.className = "status-badge error";
            }
        }
        alert("Semua selesai!");
        goToTab(3);
    }

    function cleanMetadata(data) {
        // Gabungkan semua keyword jadi satu string lalu pecah per kata
        let raw = (Array.isArray(data.keywords) ? data.keywords.join(' ') : data.keywords).toLowerCase();
        
        // Buang kata terlarang dan pecah menjadi kata tunggal
        let words = raw.replace(/4k|uhd|resolution|hd|video|camera|premium/g, '')
                       .split(/[,\s]+/)
                       .filter(w => w.length > 2);
        
        words = [...new Set(words)]; // Hapus duplikat

        // Paksa jumlah 39-41
        const fill = ['background', 'concept', 'natural', 'view', 'isolated', 'scenery', 'element', 'outdoor', 'bright', 'composition'];
        if(words.length > 40) {
            words = words.slice(0, 40);
        } else {
            while(words.length < 39) {
                let f = fill[Math.floor(Math.random() * fill.length)];
                if(!words.includes(f)) words.push(f);
            }
        }

        return {
            title: data.title || "No Title Generated",
            desc: data.description || "No Description Generated",
            keywords: words.join(', ')
        };
    }

    function renderResult(item, data) {
        const div = document.createElement('div');
        div.className = 'result-item';
        const kwCount = data.keywords.split(',').length;
        
        div.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
                <img src="${item.preview}" class="img-mini">
                <strong>${item.name}</strong>
            </div>
            <div class="result-grid">
                <div class="data-field">
                    <span class="data-label">Title</span>
                    <button class="copy-btn" onclick="copyThis(this)">Salin</button>
                    <div class="text-content">${data.title}</div>
                </div>
                <div class="data-field">
                    <span class="data-label">Description</span>
                    <button class="copy-btn" onclick="copyThis(this)">Salin</button>
                    <div class="text-content">${data.desc}</div>
                </div>
                <div class="data-field">
                    <span class="data-label">Keywords (${kwCount} words)</span>
                    <button class="copy-btn" onclick="copyThis(this)">Salin</button>
                    <div class="text-content" style="font-size:12px;">${data.keywords}</div>
                </div>
            </div>
        `;
        document.getElementById('resultsList').appendChild(div);
    }

    function copyThis(btn) {
        const text = btn.parentElement.querySelector('.text-content').innerText;
        navigator.clipboard.writeText(text);
        btn.innerText = "âœ“ OK";
        btn.style.background = "#16a34a";
        setTimeout(() => { btn.innerText = "Salin"; btn.style.background = "#64748b"; }, 1500);
    }
</script>

</body>
</html>
