<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata V8.5 - Anti Gagal & Smart Limit</title>
    <style>
        :root { --primary: #2563eb; --success: #059669; --error: #dc2626; --dark: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 900px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .tabs { display: flex; background: var(--dark); padding: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: 600; font-size: 13px; border-radius: 6px; }
        .tab-btn.active { color: white; background: rgba(255,255,255,0.1); }
        .content { padding: 30px; display: none; }
        .content.active { display: block; }
        .api-link { color: var(--primary); font-size: 13px; text-decoration: none; font-weight: bold; }
        .drop-zone { border: 2px dashed #cbd5e1; padding: 40px 20px; text-align: center; border-radius: 12px; cursor: pointer; background: #f8fafc; }
        .result-card { border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px; background: #fff; border-left: 5px solid var(--primary); }
        .label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .box-text { background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 14px; margin-bottom: 10px; position: relative; }
        .btn-copy { position: absolute; right: 8px; top: 8px; background: #e2e8f0; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-main { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn-blue { background: var(--primary); color: white; }
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .s-run { background: #dbeafe; color: #1e40af; }
        .s-done { background: #d1fae5; color: #065f46; }
        .s-err { background: #fee2e2; color: #991b1b; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .img-pre { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active">1. SETUP API</button>
        <button class="tab-btn">2. UPLOAD</button>
        <button class="tab-btn">3. PROSES</button>
        <button class="tab-btn">4. HASIL</button>
    </div>

    <div class="content active" id="tab0">
        <h3>üîë Masukkan API Key Groq</h3>
        <input type="password" id="apiKey" placeholder="gsk_..." style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:6px; box-sizing:border-box;">
        <p><a href="https://console.groq.com/keys" target="_blank" class="api-link">Ambil API Key Gratis di sini ‚Üó</a></p>
        <button class="btn-main btn-blue" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div class="content" id="tab1">
        <div class="drop-zone" id="dropArea">
            <span style="font-size:30px">üì∑</span>
            <p><b>Klik atau Tarik Gambar</b><br>Support banyak file sekaligus</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        </div>
        <div id="fileInfo" style="margin:15px 0; text-align:center; font-weight:bold; color:var(--success)"></div>
        <button class="btn-main btn-blue" id="btnNext" style="display:none" onclick="changeTab(2)">Lanjut ke Proses ‚û°Ô∏è</button>
    </div>

    <div class="content" id="tab2">
        <button class="btn-main btn-blue" id="btnStart" onclick="startAI()">üöÄ Mulai Generate Metadata</button>
        <table id="queueTable"></table>
    </div>

    <div class="content" id="tab3">
        <div id="finalResults"></div>
        <button class="btn-main btn-blue" style="background:#64748b" onclick="location.reload()">üîÑ Reset & Upload Lagi</button>
    </div>
</div>

<script>
    let filesData = [];
    let results = [];

    function changeTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const val = document.getElementById('apiKey').value.trim();
        if(val.startsWith('gsk_')) { localStorage.setItem('GROQ_KEY_V85', val); changeTab(1); }
        else alert("API Key tidak valid!");
    }
    if(localStorage.getItem('GROQ_KEY_V85')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY_V85');

    const dropArea = document.getElementById('dropArea');
    const fInput = document.getElementById('fileInput');
    dropArea.onclick = () => fInput.click();
    fInput.onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        for(let f of files) {
            const compressed = await compressImage(f);
            filesData.push({ id: filesData.length, name: f.name, base64: compressed.split(',')[1], preview: URL.createObjectURL(f), done: false });
            document.getElementById('queueTable').innerHTML += `
                <tr id="row-${filesData.length-1}">
                    <td><img src="${URL.createObjectURL(f)}" class="img-pre"></td>
                    <td>${f.name}</td>
                    <td id="st-${filesData.length-1}"><span class="status-badge">Menunggu</span></td>
                </tr>`;
        }
        document.getElementById('fileInfo').innerText = filesData.length + " File Siap";
        document.getElementById('btnNext').style.display = "block";
    }

    // Kompresi Gambar biar gak Error 413 (Payload Too Large)
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Perkecil resolusi untuk API
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); // Kualitas 60% cukup untuk AI
                };
            };
        });
    }

    async function startAI() {
        const key = localStorage.getItem('GROQ_KEY_V85');
        const btn = document.getElementById('btnStart');
        btn.disabled = true;

        for(let item of filesData) {
            if(item.done) continue;
            const statusBox = document.getElementById(`st-${item.id}`);
            statusBox.innerHTML = `<span class="status-badge s-run">Memproses...</span>`;

            let success = false;
            let retryCount = 0;

            while(!success && retryCount < 2) {
                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "llama-3.2-11b-vision-preview",
                            messages: [{ role: "user", content: [
                                { type: "text", text: "Expert Microstock Metadata. Requirements: 1.Title (simple), 2.Description (40-100 chars), 3.Exactly 40 single-word keywords. JSON format." },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }
                            ]}],
                            temperature: 0.2,
                            response_format: { type: "json_object" }
                        })
                    });

                    const resData = await response.json();

                    if(response.status === 429) {
                        statusBox.innerHTML = `<span class="status-badge s-err">Limit Habis, Nunggu 30dtk...</span>`;
                        await new Promise(r => setTimeout(r, 30000));
                        retryCount++;
                        continue;
                    }

                    if(!response.ok) throw new Error(resData.error?.message || "Koneksi Error");

                    const cleanData = JSON.parse(resData.choices[0].message.content);
                    renderResult(item, cleanData);
                    statusBox.innerHTML = `<span class="status-badge s-done">Selesai</span>`;
                    item.done = true;
                    success = true;
                    await new Promise(r => setTimeout(r, 5000)); // Jeda antar request agar tidak kena limit lagi

                } catch (err) {
                    statusBox.innerHTML = `<span class="status-badge s-err">Error: ${err.message}</span>`;
                    retryCount = 5; // Berhenti jika error permanen
                }
            }
        }
        btn.disabled = false;
        btn.innerText = "Selesai! Cek Hasil";
        if(filesData.every(f => f.done)) changeTab(3);
    }

    function renderResult(item, data) {
        const div = document.createElement('div');
        div.className = 'result-card';
        // Logic keyword padding agar pas 40 kata
        let kws = data.keywords.split(',').map(k => k.trim()).filter(k => k.length > 1);
        while(kws.length < 40) kws.push("footage", "video", "cinematic", "background");
        const finalKws = kws.slice(0, 42).join(', ');

        div.innerHTML = `
            <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                <img src="${item.preview}" style="width:30px;height:30px;object-fit:cover;border-radius:4px;">
                <b>${item.name}</b>
            </div>
            <span class="label">Title</span>
            <div class="box-text">${data.title} <button class="btn-copy" onclick="copyTxt('${data.title}', this)">Copy</button></div>
            <span class="label">Description</span>
            <div class="box-text">${data.description} <button class="btn-copy" onclick="copyTxt('${data.description}', this)">Copy</button></div>
            <span class="label">Keywords (${kws.length} words)</span>
            <div class="box-text">${finalKws} <button class="btn-copy" onclick="copyTxt('${finalKws}', this)">Copy</button></div>
        `;
        document.getElementById('finalResults').appendChild(div);
    }

    function copyTxt(text, btn) {
        navigator.clipboard.writeText(text);
        const oldText = btn.innerText;
        btn.innerText = "‚úì";
        setTimeout(() => btn.innerText = oldText, 1000);
    }
</script>
</body>
</html>
