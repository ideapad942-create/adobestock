<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Batch Metadata v2026</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --dark: #0f172a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 900px; margin: auto; background: var(--card); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Tabs */
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--primary); background: rgba(255,255,255,0.1); }
        
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }

        /* Input & Buttons */
        input[type="password"], input[type="file"] { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }
        .main-btn:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* Table & Status */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #e2e8f0; padding: 12px; text-align: left; }
        .img-mini { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; }
        .badge { padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .status-wait { background: #f1f5f9; color: #64748b; }
        .status-run { background: #dbeafe; color: #1e40af; animation: blink 1s infinite; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-err { background: #fee2e2; color: #991b1b; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .result-card { border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px; position: relative; }
        .copy-btn { position: absolute; top: 15px; right: 15px; background: #64748b; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="btn0" onclick="switchTab(0)">1. API SETTINGS</button>
        <button class="tab-btn" id="btn1" onclick="switchTab(1)">2. UPLOAD</button>
        <button class="tab-btn" id="btn2" onclick="switchTab(2)">3. PROSES</button>
        <button class="tab-btn" id="btn3" onclick="switchTab(3)">4. HASIL</button>
    </div>

    <div id="tab0" class="tab-content active">
        <h2>Setup API Key</h2>
        <p>Gunakan API Key Groq untuk memproses gambar.</p>
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxx">
        <div style="margin-bottom: 20px;">
            <a href="https://console.groq.com/keys" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: bold;">
                ðŸ‘‰ Klik di sini untuk membuat API Key (Gratis)
            </a>
        </div>
        <button class="main-btn" onclick="saveKey()">Simpan & Lanjut ke Upload</button>
    </div>

    <div id="tab1" class="tab-content">
        <h2>Upload Foto</h2>
        <p>Pilih foto yang ingin dibuat metadatanya (Batch).</p>
        <input type="file" id="filePicker" multiple accept="image/*" onchange="initQueue(this.files)">
        <div id="fileInfo" style="margin: 10px 0; font-weight: bold; color: var(--primary);"></div>
        <button class="main-btn" id="toTab2" style="display:none" onclick="switchTab(2)">Lanjut ke Pemrosesan AI</button>
    </div>

    <div id="tab2" class="tab-content">
        <h2>Pemrosesan AI</h2>
        <p>Klik tombol di bawah untuk mulai menganalisis foto.</p>
        <button class="main-btn" id="startBtn" onclick="processAll()">Mulai Generate Metadata</button>
        <table>
            <thead><tr><th>Foto</th><th>Nama File</th><th>Status</th></tr></thead>
            <tbody id="queueList"></tbody>
        </table>
    </div>

    <div id="tab3" class="tab-content">
        <h2>Hasil Metadata Selesai</h2>
        <div id="outputArea"></div>
        <button class="main-btn" style="background:#475569" onclick="location.reload()">Bersihkan Semua & Ulangi</button>
    </div>
</div>

<script>
    let images = [];

    function switchTab(i) {
        document.querySelectorAll('.tab-content').forEach((t, idx) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, idx) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const key = document.getElementById('apiKey').value.trim();
        if(key.startsWith('gsk_')) {
            localStorage.setItem('GROQ_KEY_NEW', key);
            alert("API Key tersimpan!");
            switchTab(1);
        } else { alert("API Key tidak valid!"); }
    }

    // Load key jika ada
    const saved = localStorage.getItem('GROQ_KEY_NEW');
    if(saved) document.getElementById('apiKey').value = saved;

    function initQueue(files) {
        images = [];
        const list = document.getElementById('queueList');
        list.innerHTML = "";
        Array.from(files).forEach((f, i) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                images.push({ id: i, name: f.name, base64: e.target.result.split(',')[1], preview: e.target.result });
                list.innerHTML += `<tr>
                    <td><img src="${e.target.result}" class="img-mini"></td>
                    <td>${f.name}</td>
                    <td id="status-${i}"><span class="badge status-wait">Menunggu</span></td>
                </tr>`;
            };
            reader.readAsDataURL(f);
        });
        document.getElementById('fileInfo').innerText = files.length + " foto siap diproses.";
        document.getElementById('toTab2').style.display = "block";
    }

    async function processAll() {
        const key = localStorage.getItem('GROQ_KEY_NEW');
        if(!key) return alert("API Key belum diset!");
        
        document.getElementById('startBtn').disabled = true;

        for(let img of images) {
            const stCell = document.getElementById(`status-${img.id}`);
            stCell.innerHTML = `<span class="badge status-run">Memproses...</span>`;

            try {
                // Gunakan Controller untuk timeout agar tidak stuck
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 40000); // 40 detik timeout

                const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct", // Model Rekomendasi 2026
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: "Create Microstock Metadata. English. Return JSON with 'title', 'description', and 'keywords' (list of 50-60 single words). No technical camera specs." },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${img.base64}` } }
                            ]
                        }],
                        response_format: { type: "json_object" }
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await resp.json();
                
                if(data.error) throw new Error(data.error.message);

                const aiMsg = JSON.parse(data.choices[0].message.content);
                addResult(img, formatMeta(aiMsg));
                
                stCell.innerHTML = `<span class="badge status-ok">Selesai</span>`;
            } catch (e) {
                console.error(e);
                stCell.innerHTML = `<span class="badge status-err">Error: ${e.message.substring(0,20)}...</span>`;
            }
            // Jeda 2 detik agar API tidak overload
            await new Promise(r => setTimeout(r, 2000));
        }
        
        alert("Seluruh foto selesai diproses!");
        switchTab(3);
    }

    function formatMeta(data) {
        let rawKw = (Array.isArray(data.keywords) ? data.keywords.join(' ') : String(data.keywords)).toLowerCase();
        let words = rawKw.replace(/4k|uhd|resolution|hd|video|30fps|60fps/g, '').split(/[,\s]+/).filter(w => w.length > 2);
        words = [...new Set(words)]; // Hapus duplikat

        // Paksa 40 kata
        const fillers = ['background', 'concept', 'isolated', 'scenery', 'natural', 'view', 'composition', 'daylight', 'outdoor', 'nobody'];
        if(words.length > 40) words = words.slice(0, 40);
        else while(words.length < 40) {
            let f = fillers[Math.floor(Math.random() * fillers.length)];
            if(!words.includes(f)) words.push(f);
        }

        return { title: data.title, desc: data.description, kw: words.join(', ') };
    }

    function addResult(img, meta) {
        const out = document.getElementById('outputArea');
        const card = document.createElement('div');
        card.className = 'result-card';
        card.innerHTML = `
            <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                <img src="${img.preview}" class="img-mini">
                <strong>${img.name}</strong>
            </div>
            <p><strong>Title:</strong><br>${meta.title} <button class="copy-btn" onclick="salin('${meta.title.replace(/'/g,"")}')">Copy</button></p>
            <p><strong>Description:</strong><br>${meta.desc} <button class="copy-btn" onclick="salin('${meta.desc.replace(/'/g,"")}')">Copy</button></p>
            <p><strong>Keywords (40):</strong><br><span style="font-size:12px; color:#64748b;">${meta.kw}</span> <button class="copy-btn" onclick="salin('${meta.kw}')">Copy</button></p>
        `;
        out.appendChild(card);
    }

    function salin(t) {
        navigator.clipboard.writeText(t);
        alert("Tersalin!");
    }
</script>

</body>
</html>
