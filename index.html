<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata Generator - Llama 4 Scout Version</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; --dark: #0f172a; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: var(--card); border-radius: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--primary); background: rgba(255,255,255,0.05); }
        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }
        .main-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .main-btn:disabled { background: #ccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
        .img-mini { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .error-msg { color: #dc2626; font-size: 10px; display: block; margin-top: 4px; max-width: 200px; word-wrap: break-word; }
        .pending { background: #f1f5f9; }
        .loading { background: #dbeafe; color: #1e40af; }
        .done { background: #dcfce7; color: #166534; }
        .error { background: #fee2e2; color: #991b1b; }
        .result-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .copy-btn { background: #64748b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; float: right; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab(0)">1. API KEY</button>
        <button class="tab-btn" onclick="showTab(1)">2. UPLOAD</button>
        <button class="tab-btn" onclick="showTab(2)">3. PROSES</button>
        <button class="tab-btn" onclick="showTab(3)">4. HASIL</button>
    </div>

    <div id="t0" class="tab-content active">
        <h3>Langkah 1: Masukkan API Key</h3>
        <input type="password" id="keyInput" placeholder="gsk_..." style="width:100%; padding:10px; margin-bottom:10px;">
        <p style="font-size:12px;">Update 2026: Menggunakan model <b>Llama 4 Scout</b>.</p>
        <button class="main-btn" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="t1" class="tab-content">
        <h3>Langkah 2: Upload Gambar</h3>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="prepareFiles(this.files)">
        <button class="main-btn" id="toTab2Btn" style="display:none;" onclick="showTab(2)">Lanjut ke Proses</button>
    </div>

    <div id="t2" class="tab-content">
        <h3>Langkah 3: Menjalankan AI</h3>
        <button class="main-btn" id="runBtn" onclick="processQueue()">Mulai Generate Metadata</button>
        <table>
            <thead><tr><th>Foto</th><th>Nama</th><th>Status</th></tr></thead>
            <tbody id="queueTbody"></tbody>
        </table>
    </div>

    <div id="t3" class="tab-content">
        <h3>Langkah 4: Hasil Metadata</h3>
        <div id="finalResults"></div>
        <button class="main-btn" style="background:#4b5563" onclick="location.reload()">Mulai Ulang</button>
    </div>
</div>

<script>
    let queue = [];
    
    function showTab(i) {
        document.querySelectorAll('.tab-content').forEach((t, idx) => t.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, idx) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const val = document.getElementById('keyInput').value.trim();
        if(val.startsWith('gsk_')) {
            localStorage.setItem('GROQ_API_KEY_2026', val);
            alert("API Key Berhasil Disimpan!");
            showTab(1);
        } else { alert("API Key tidak valid!"); }
    }

    if(localStorage.getItem('GROQ_API_KEY_2026')) document.getElementById('keyInput').value = localStorage.getItem('GROQ_API_KEY_2026');

    function prepareFiles(files) {
        queue = [];
        const tbody = document.getElementById('queueTbody');
        tbody.innerHTML = "";
        Array.from(files).forEach((f, i) => {
            const r = new FileReader();
            r.onload = (e) => {
                queue.push({ id: i, name: f.name, base64: e.target.result.split(',')[1], preview: e.target.result });
                tbody.innerHTML += `<tr>
                    <td><img src="${e.target.result}" class="img-mini"></td>
                    <td>${f.name}</td>
                    <td id="stat-cell-${i}"><span class="status-badge pending">Siap</span></td>
                </tr>`;
            };
            r.readAsDataURL(f);
        });
        document.getElementById('toTab2Btn').style.display = "block";
    }

    async function processQueue() {
        const key = localStorage.getItem('GROQ_API_KEY_2026');
        const btn = document.getElementById('runBtn');
        btn.disabled = true;

        for(let item of queue) {
            const cell = document.getElementById(`stat-cell-${item.id}`);
            cell.innerHTML = `<span class="status-badge loading">Memproses...</span>`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct", // Model Pengganti Sesuai Rekomendasi 2026
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: "Create Microstock Metadata. Return JSON: {title: 'string (80 chars)', description: 'string (200 chars)', keywords: 'string (60 single words)'}. No technical terms (4k, uhd, resolution)." },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }
                            ]
                        }],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const content = JSON.parse(data.choices[0].message.content);
                const clean = finalizeMetadata(content);
                renderFinal(item, clean);

                cell.innerHTML = `<span class="status-badge done">Selesai</span>`;
            } catch (err) {
                cell.innerHTML = `<span class="status-badge error">Error!</span><span class="error-msg">${err.message}</span>`;
            }
            await new Promise(r => setTimeout(r, 1500)); // Delay sedikit lebih lama untuk Llama 4
        }
        btn.disabled = false;
        showTab(3);
    }

    function finalizeMetadata(data) {
        let kw = (Array.isArray(data.keywords) ? data.keywords.join(' ') : String(data.keywords))
                 .toLowerCase()
                 .replace(/4k|uhd|resolution|hd|video|frame rate|fps|prores/g, '')
                 .split(/[,\s]+/)
                 .filter(w => w.length > 2);
        
        kw = [...new Set(kw)];
        const fillers = ['background', 'composition', 'isolated', 'scenery', 'outdoor', 'daylight', 'natural', 'view', 'nobody', 'atmosphere'];
        
        if(kw.length > 40) kw = kw.slice(0, 40);
        else while(kw.length < 39) {
            let f = fillers[Math.floor(Math.random() * fillers.length)];
            if(!kw.includes(f)) kw.push(f);
        }

        return { title: data.title, desc: data.description, keywords: kw.join(', ') };
    }

    function renderFinal(item, data) {
        const container = document.getElementById('finalResults');
        const count = data.keywords.split(',').length;
        container.innerHTML += `
            <div class="result-box">
                <img src="${item.preview}" class="img-mini"> <strong>${item.name}</strong>
                <p><strong>Title:</strong> <button class="copy-btn" onclick="cp(this, '${data.title.replace(/'/g,"")}')">Salin Judul</button><br>${data.title}</p>
                <p><strong>Description:</strong> <button class="copy-btn" onclick="cp(this, '${data.desc.replace(/'/g,"")}')">Salin Deskripsi</button><br>${data.desc}</p>
                <p><strong>Keywords (${count}):</strong> <button class="copy-btn" onclick="cp(this, '${data.keywords}')">Salin Keywords</button><br><span style="font-size:12px;">${data.keywords}</span></p>
            </div>
        `;
    }

    function cp(btn, txt) {
        navigator.clipboard.writeText(txt);
        btn.innerText = "âœ“ OK";
        setTimeout(() => btn.innerText = "Salin", 1500);
    }
</script>

</body>
</html>
