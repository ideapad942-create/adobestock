<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata V9 - Video SEO (Maximized)</title>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --dark: #0f172a; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 950px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #94a3b8; cursor: not-allowed; font-weight: 600; transition: 0.3s; font-size: 14px; letter-spacing: 1px; }
        .tab-btn.active { color: white; background: var(--primary); cursor: default; border-bottom: 4px solid #818cf8; }

        .content { padding: 40px; display: none; }
        .content.active { display: block; }

        /* UPLOAD AREA */
        .drop-zone { 
            border: 2px dashed #cbd5e1; 
            padding: 60px 20px; 
            text-align: center; 
            border-radius: 16px; 
            cursor: pointer; 
            background: #f8fafc; 
            transition: 0.3s; 
            position: relative;
        }
        .drop-zone:hover, .drop-zone.drag-over { 
            border-color: var(--primary); 
            background: #eef2ff; 
            transform: translateY(-2px);
        }
        .drop-zone p { margin: 15px 0 0; color: #64748b; font-size: 14px; }

        /* RESULT CARD */
        .result-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .field-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: 18px; display: block; letter-spacing: 0.8px; }
        
        .copy-wrapper { display: flex; align-items: center; gap: 12px; background: #f8fafc; padding: 12px 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 6px; }
        .field-val { font-size: 14px; color: #1e293b; flex-grow: 1; font-family: 'Segoe UI', sans-serif; line-height: 1.5; text-align: justify; }
        
        .btn-copy { background: #e2e8f0; color: #475569; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .btn-copy:hover { background: #cbd5e1; color: #0f172a; }
        .btn-copy.copied { background: var(--success); color: white; }

        /* BUTTONS */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 15px; transition: 0.2s; letter-spacing: 0.5px; }
        .btn-blue { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .btn-blue:hover { background: #4338ca; transform: translateY(-1px); }
        .btn-green { background: var(--success); color: white; }
        .btn-gray { background: #64748b; color: white; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
        .img-mini { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #e2e8f0; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .s-ready { background: #f1f5f9; color: #64748b; }
        .s-run { background: #e0e7ff; color: #4338ca; animation: pulse 1s infinite; }
        .s-done { background: #d1fae5; color: #065f46; }
        @keyframes pulse { 50% { opacity: 0.6; } }

        /* Added Link Style */
        .help-link { color: var(--primary); text-decoration: none; font-weight: 600; font-size: 13px; margin-top: 10px; display: inline-block; }
        .help-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="t0">1. API KEY</button>
        <button class="tab-btn" id="t1">2. UPLOAD</button>
        <button class="tab-btn" id="t2">3. PROSES</button>
        <button class="tab-btn" id="t3">4. HASIL</button>
    </div>

    <div id="c0" class="content active">
        <h2 style="margin-top:0">üîë Setup API</h2>
        <p style="color:#64748b; font-size:14px; margin-bottom:10px;">Masukkan API Key Groq Anda untuk memulai.</p>
        
        <div style="background:#eef2ff; padding:15px; border-radius:8px; border:1px solid #c7d2fe; margin-bottom:20px;">
            <p style="margin:0; font-size:13px; color:#3730a3;">
                ‚ÑπÔ∏è Belum punya API Key? Buat gratis di sini: <br>
                <a href="https://console.groq.com/keys" target="_blank" class="help-link">üëâ https://console.groq.com/keys</a>
            </p>
        </div>

        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxx" style="width:100%; padding:16px; border:1px solid #cbd5e1; border-radius:8px; font-size:16px; box-sizing: border-box;">
        <button class="btn btn-blue" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="c1" class="content">
        <h2 style="margin-top:0">üìÅ Upload Asset</h2>
        <div id="dropArea" class="drop-zone">
            <span style="font-size:40px;">üé¨</span><br>
            <strong style="font-size:18px; display:block; margin-top:10px;">Drag & Drop File Di Sini (Unlimited)</strong>
            <span style="font-size:13px; color:#94a3b8">Bisa banyak foto sekaligus. <strong>CTRL+V</strong> juga bisa.</span>
            <p>Sistem akan menganggap ini sebagai VIDEO FOOTAGE</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="fileStatus" style="margin-top:20px; text-align:center; font-weight:bold; color:var(--success);"></div>
        <button class="btn btn-blue" id="btnNext" style="display:none;" onclick="goToTab(2)">Lanjut ke Proses AI ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <h2 style="margin-top:0">‚ö° AI Video Processing</h2>
        <button class="btn btn-blue" id="btnStart" onclick="startProcessing()">üöÄ Mulai Generate Metadata</button>
        <div style="max-height: 400px; overflow-y: auto; margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <table style="margin-top:0;">
                <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                    <tr><th>Preview</th><th>File</th><th>Status</th></tr>
                </thead>
                <tbody id="queueList"></tbody>
            </table>
        </div>
    </div>

    <div id="c3" class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:30px;">
            <button class="btn btn-green" style="margin-top:0" onclick="exportCSV()">üì• Download CSV</button>
            <button class="btn btn-gray" style="margin-top:0" onclick="resetAll()">üîÑ Reset / Upload Lagi</button>
        </div>
        <div id="resultContainer"></div>
    </div>
</div>

<script>
    let queue = [];
    let results = [];
    const dropArea = document.getElementById('dropArea');

    // --- SETUP DRAG & DROP & PASTE ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => {
        dropArea.addEventListener(n, pD, false); document.body.addEventListener(n, pD, false);
    });
    function pD(e){ e.preventDefault(); e.stopPropagation(); }
    
    dropArea.addEventListener('dragenter', () => dropArea.classList.add('drag-over'));
    dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
    dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
    dropArea.addEventListener('click', () => document.getElementById('fileInput').click());
    
    document.addEventListener('paste', (e) => {
        if(document.querySelector('.container').style.display === 'none') return;
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        const files = [];
        for (let index in items) {
            if (items[index].kind === 'file') files.push(new File([items[index].getAsFile()], `pasted_${Date.now()}.png`, { type: 'image/png' }));
        }
        if(files.length > 0) { goToTab(1); handleFiles(files); }
    });

    // --- LOGIKA UTAMA V9 (UPDATED PROMPT) ---
    const SYSTEM_PROMPT = `
    Role: Senior Metadata Specialist for US Microstock Video (Shutterstock, Adobe Stock, Pond5).
    Task: Analyze the image and generate VIDEO FOOTAGE metadata.

    REQUIREMENTS:
    1. **TITLE**: Must be **Simple**, direct, and visually accurate based on the analysis. Focus on what is happening.
    2. **DESCRIPTION**: Write a detailed explanation of the title and the visual context.
       - Constraint: **Must be between 50 and 100 words**.
       - Explain the subject, action, lighting, and potential usage context.
    3. **KEYWORDS**: 
       - **SINGLE WORDS ONLY**. Split ALL phrases. (e.g., "film burn" -> "film", "burn").
       - Include strictly related synonyms and supporting words.
       - **BANNED WORDS**: vector, image, photo, picture, jpg, png, ai, eps, illustration.
       - **REQUIRED**: footage, video, clip, animation, render.

    JSON Output: {"title": "Simple Title Here", "description": "Longer description here (50-100 words)...", "keywords": "word1, word2, word3..."}
    `;

    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_V9_KEY', k); goToTab(1); } else alert("API Key Salah! Harus berawalan gsk_");
    }
    if(localStorage.getItem('GROQ_V9_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_V9_KEY');

    async function handleFiles(files) {
        if (files.length === 0) return;
        // Tidak reset queue agar bisa tambah file (unlimited add)
        // queue = []; 
        // document.getElementById('queueList').innerHTML = "";
        
        const startId = queue.length;
        document.getElementById('fileStatus').innerText = `Menambahkan ${files.length} file...`;
        
        for (let i = 0; i < files.length; i++) {
            const currentId = startId + i;
            const c = await compressImage(files[i]);
            queue.push({ id: currentId, name: files[i].name, base64: c.data, preview: c.preview });
            document.getElementById('queueList').innerHTML += `<tr><td><img src="${c.preview}" class="img-mini"></td><td>${files[i].name}</td><td id="status-${currentId}"><span class="status-badge s-ready">Ready</span></td></tr>`;
        }
        document.getElementById('fileStatus').innerText = `${queue.length} File Siap Diproses!`;
        document.getElementById('btnNext').style.display = 'block';
    }

    function compressImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scl = 512 / Math.max(img.width, img.height);
                    cvs.width = img.width * scl; cvs.height = img.height * scl;
                    cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                    resolve({ data: cvs.toDataURL('image/jpeg', 0.7).split(',')[1], preview: e.target.result });
                };
            };
        });
    }

    async function startProcessing() {
        const k = localStorage.getItem('GROQ_V9_KEY');
        if(!k) { alert("Masukkan API Key dulu!"); goToTab(0); return; }

        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStart').innerText = "Sedang Generate Metadata...";
        results = [];

        // Loop melalui queue
        for (let item of queue) {
            // Cek jika sudah diproses (untuk menghindari duplikasi jika klik start 2x)
            const statusEl = document.getElementById(`status-${item.id}`);
            if(statusEl.innerHTML.includes('Done')) continue;

            statusEl.innerHTML = `<span class="status-badge s-run">Working...</span>`;
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.2-90b-vision-preview", // Menggunakan model vision yang stabil
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [{ type: "text", text: `Analyze this image for video metadata: ${item.name}` }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }] }
                        ], temperature: 0.1, response_format: { type: "json_object" }
                    })
                });
                
                if(!res.ok) throw new Error("API Error");
                
                const json = await res.json();
                const content = JSON.parse(json.choices[0].message.content);
                const finalData = processKeywords(content);
                
                results.push({ filename: item.name, ...finalData });
                renderResult(item, finalData);
                statusEl.innerHTML = `<span class="status-badge s-done">Done</span>`;
            } catch (e) {
                console.error(e);
                statusEl.innerHTML = `<span style="color:red; font-size:10px;">Gagal</span>`;
            }
            // Delay sedikit agar tidak rate limit agresif
            await new Promise(r => setTimeout(r, 1500));
        }
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStart').innerText = "üöÄ Mulai Generate";
        goToTab(3);
    }

    // --- SMART KEYWORD PROCESSOR (SINGLE WORD ENFORCER) ---
    function processKeywords(data) {
        // 1. Ambil raw string
        let kwRaw = (Array.isArray(data.keywords) ? data.keywords.join(' ') : data.keywords);
        
        // 2. TOKENISASI AGRESIF (Memisahkan koma DAN spasi)
        // User request: "pisahakn film, burn, overlays" -> ini otomatis terjadi di sini
        let kw = kwRaw.toLowerCase()
            .replace(/[^a-z0-9\s,]/g, '') // Hapus simbol aneh
            .replace(/[,\s]+/g, ' ')      // Ganti koma/spasi berlebih dengan 1 spasi
            .split(' ')                   // Pecah jadi array berdasarkan spasi
            .map(k => k.trim())
            .filter(k => k.length > 2);   // Hapus kata < 3 huruf

        // 3. BLACKLIST FILTER
        const banned = ['vector', 'image', 'photo', 'picture', 'jpg', 'png', 'jpeg', 'eps', 'ai', 'svg', 'download', 'illustration'];
        kw = kw.filter(w => !banned.includes(w));

        // 4. MANDATORY VIDEO TAGS (Wajib ada)
        const videoTags = ['animation', 'footage', 'video', 'clip', 'motion', 'loop', 'background', 'overlay', 'render', 'hd', '4k'];
        videoTags.forEach(t => { if(!kw.includes(t)) kw.push(t); });

        // 5. FILLER JIKA KURANG
        const fillers = [
            'creative', 'modern', 'abstract', 'art', 'design', 'concept', 'backdrop', 
            'effect', 'technology', 'digital', 'screen', 'display', 'business', 'cinematic'
        ];
        
        kw = [...new Set(kw)]; // Hapus duplikat

        let i = 0;
        while (kw.length < 40 && i < fillers.length) {
            if (!kw.includes(fillers[i])) kw.push(fillers[i]);
            i++;
        }

        // 6. LIMIT 50 KATA
        if (kw.length > 50) kw = kw.slice(0, 50);

        return {
            title: data.title,
            description: data.description,
            keywords: kw.join(', ') // Gabung kembali dengan koma
        };
    }

    function renderResult(item, data) {
        // Hitung kata deskripsi
        const descWords = data.description.split(/\s+/).length;
        const kwCount = data.keywords.split(',').length;

        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div style="display:flex; gap:15px; align-items:center; border-bottom:1px solid #f1f5f9; padding-bottom:15px; margin-bottom:15px;">
                <img src="${item.preview}" class="img-mini">
                <div>
                    <strong style="font-size:16px;">${item.name}</strong><br>
                    <span style="font-size:11px; color:#64748b;">
                        Desc: <b>${descWords} words</b> | Keywords: <b>${kwCount} tags</b>
                    </span>
                </div>
            </div>
            
            <span class="field-label">TITLE (Simple & Accurate)</span>
            <div class="copy-wrapper">
                <div class="field-val" id="t-${item.id}">${data.title}</div>
                <button class="btn-copy" onclick="copyText(this, 't-${item.id}')">Copy</button>
            </div>

            <span class="field-label">DESCRIPTION (50-100 Words)</span>
            <div class="copy-wrapper">
                <div class="field-val" id="d-${item.id}">${data.description}</div>
                <button class="btn-copy" onclick="copyText(this, 'd-${item.id}')">Copy</button>
            </div>

            <span class="field-label">KEYWORDS (Single Words Only)</span>
            <div class="copy-wrapper">
                <div class="field-val" id="k-${item.id}">${data.keywords}</div>
                <button class="btn-copy" onclick="copyText(this, 'k-${item.id}')">Copy</button>
            </div>
        `;
        document.getElementById('resultContainer').appendChild(div);
    }

    function copyText(btn, id) {
        const txt = document.getElementById(id).innerText;
        const doCopy = () => {
            btn.innerText = "Copied!"; btn.classList.add('copied');
            setTimeout(() => { btn.innerText = "Copy"; btn.classList.remove('copied'); }, 1500);
        };
        if(navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(txt).then(doCopy);
        else {
            const ta = document.createElement("textarea");
            ta.value = txt; ta.style.position="fixed"; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); doCopy(); } catch(e){}
            document.body.removeChild(ta);
        }
    }

    function resetAll() {
        queue = []; results = [];
        document.getElementById('queueList').innerHTML = "";
        document.getElementById('resultContainer').innerHTML = "";
        document.getElementById('fileStatus').innerText = "";
        document.getElementById('btnNext').style.display = 'none';
        document.getElementById('fileInput').value = "";
        goToTab(1);
    }

    function exportCSV() {
        if(!results.length) return alert("Belum ada data!");
        let csv = "Filename,Title,Description,Keywords\n";
        results.forEach(r => csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.description.replace(/"/g,'""')}","${r.keywords}"\n`);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
        a.download = `Metadata_Video_Maximized_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>
