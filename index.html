<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata SEO Master V3</title>
    <style>
        :root { --primary: #2563eb; --success: #059669; --dark: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 950px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Navigasi */
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #94a3b8; cursor: not-allowed; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { color: white; background: var(--primary); cursor: default; }

        .content { padding: 30px; display: none; }
        .content.active { display: block; }

        /* Area Upload */
        .drop-zone { border: 2px dashed #cbd5e1; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; background: #f8fafc; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--primary); background: #eff6ff; }
        .drop-zone strong { font-size: 16px; color: var(--dark); }

        /* Tabel & Status */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
        .img-mini { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .s-ready { background: #e2e8f0; color: #64748b; }
        .s-run { background: #dbeafe; color: #1e40af; animation: pulse 1s infinite; }
        .s-done { background: #d1fae5; color: #047857; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* Output Card */
        .result-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .field-label { font-size: 11px; font-weight: bold; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 10px; display: block; }
        .field-val { font-size: 14px; color: #1e293b; line-height: 1.5; }
        .kw-box { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px dashed #cbd5e1; margin-top: 5px; font-size: 13px; color: #475569; }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 15px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-gray { background: #64748b; color: white; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn:hover:not(:disabled) { opacity: 0.9; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="t0">1. API KEY</button>
        <button class="tab-btn" id="t1">2. UPLOAD</button>
        <button class="tab-btn" id="t2">3. PROSES AI</button>
        <button class="tab-btn" id="t3">4. HASIL & EXPORT</button>
    </div>

    <div id="c0" class="content active">
        <h2>üîë Konfigurasi API</h2>
        <p style="color:#64748b; font-size:14px;">Masukkan API Key Groq Anda untuk memulai.</p>
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxx" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; box-sizing:border-box;">
        <div style="margin-top:10px;">
            <a href="https://console.groq.com/keys" target="_blank" style="color:var(--primary); font-weight:bold; font-size:13px; text-decoration:none;">üëâ Buat API Key Gratis Disini</a>
        </div>
        <button class="btn btn-blue" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="c1" class="content">
        <h2>üìÅ Upload Gambar</h2>
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <span style="font-size:24px;">üì∏</span><br>
            <strong>Klik disini untuk pilih foto</strong><br>
            <span style="font-size:12px; color:#94a3b8;">Bisa pilih banyak sekaligus (Batch)</span>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="fileStatus" style="margin-top:15px; text-align:center; font-weight:bold; color:var(--success);"></div>
        <button class="btn btn-blue" id="btnNextToProcess" style="display:none;" onclick="goToTab(2)">Lanjut ke Proses ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <h2>‚ö° Pemrosesan Metadata</h2>
        <p style="font-size:13px; color:#64748b;">AI akan membuat Title, Description, & 50 Keywords SEO Friendly.</p>
        <button class="btn btn-blue" id="btnStart" onclick="startProcessing()">üöÄ Mulai Generate Sekarang</button>
        <table>
            <thead><tr><th>Foto</th><th>Nama File</th><th>Status</th></tr></thead>
            <tbody id="queueList"></tbody>
        </table>
    </div>

    <div id="c3" class="content">
        <h2>‚úÖ Hasil Selesai</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <button class="btn btn-green" style="margin-top:0" onclick="exportCSV()">üì• Download CSV</button>
            <button class="btn btn-gray" style="margin-top:0" onclick="resetAll()">üîÑ Upload Foto Lagi</button>
        </div>
        <div id="resultContainer"></div>
    </div>
</div>

<script>
    let queue = [];
    let results = [];
    const SYSTEM_PROMPT = `
    You are a professional Microstock SEO expert for Adobe Stock and Shutterstock. 
    Analyze the image and generate metadata designed to MAXIMIZE SALES.
    
    1. TITLE: English. Max 70 chars. Catchy, specific, includes main subject and action.
    2. DESCRIPTION: English. Min 15 words, Max 200 chars. Natural sentence describing the scene, mood, and context.
    3. KEYWORDS: English. STRICTLY 50 SINGLE WORDS. Comma-separated. Ranked by relevance. 
       - NO phrases (e.g., use 'blue, sky' NOT 'blue sky'). 
       - NO technical specs (4k, uhd, camera).
       - Include conceptual tags (e.g., freedom, success, happiness) if applicable.
    
    Output JSON format only: {"title": "...", "description": "...", "keywords": "word1, word2, ..."}
    `;

    // --- NAVIGASI ---
    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => {
            b.classList.toggle('active', i === idx);
            // Visual feedback tab steps
            if(i < idx) b.style.color = "#2563eb"; 
        });
    }

    // --- API KEY ---
    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) {
            localStorage.setItem('GROQ_V3_KEY', k);
            goToTab(1);
        } else alert("API Key tidak valid! Harus diawali 'gsk_'");
    }
    if(localStorage.getItem('GROQ_V3_KEY')) {
        document.getElementById('apiKey').value = localStorage.getItem('GROQ_V3_KEY');
    }

    // --- UPLOAD & COMPRESS ---
    async function handleFiles(files) {
        if (files.length === 0) return;
        
        queue = [];
        const tbody = document.getElementById('queueList');
        tbody.innerHTML = "";
        document.getElementById('btnNextToProcess').style.display = 'none';
        document.getElementById('fileStatus').innerText = "Sedang memuat...";

        for (let i = 0; i < files.length; i++) {
            const compressed = await compressImage(files[i]);
            queue.push({ 
                id: i, 
                file: files[i], 
                base64: compressed.data, 
                preview: compressed.preview 
            });
            
            tbody.innerHTML += `
                <tr>
                    <td><img src="${compressed.preview}" class="img-mini"></td>
                    <td>${files[i].name}</td>
                    <td id="status-${i}"><span class="status-badge s-ready">Siap</span></td>
                </tr>
            `;
        }
        
        document.getElementById('fileStatus').innerText = `${files.length} Foto Berhasil Dimuat!`;
        document.getElementById('btnNextToProcess').style.display = 'block'; // Tampilkan tombol lanjut hanya jika ada foto
    }

    function compressImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Resize ke 512px agar super cepat dan ringan
                    const scale = 512 / Math.max(img.width, img.height);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve({
                        data: canvas.toDataURL('image/jpeg', 0.6).split(',')[1], // Quality 60%
                        preview: e.target.result
                    });
                };
            };
        });
    }

    // --- PROSES AI ---
    async function startProcessing() {
        const apiKey = localStorage.getItem('GROQ_V3_KEY');
        if(!apiKey) return alert("API Key hilang, silakan set ulang.");
        
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStart').innerText = "Sedang Memproses...";
        results = [];

        for (let item of queue) {
            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerHTML = `<span class="status-badge s-run">Memproses...</span>`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct", // Model Vision Terbaru
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { 
                                role: "user", 
                                content: [
                                    { type: "text", text: "Generate high selling metadata for this image." },
                                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }
                                ] 
                            }
                        ],
                        temperature: 0.2, // Rendah agar output konsisten/tidak halusinasi
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) throw new Error("Gagal koneksi API");
                const data = await response.json();
                const content = JSON.parse(data.choices[0].message.content);
                
                // Finalisasi Data (Pembersihan & Validasi Keyword)
                const finalData = validateMetadata(content);
                
                results.push({ filename: item.file.name, ...finalData });
                renderResult(item, finalData);
                
                statusEl.innerHTML = `<span class="status-badge s-done">Sukses</span>`;

            } catch (err) {
                console.error(err);
                statusEl.innerHTML = `<span style="color:red; font-size:10px;">Gagal: ${err.message}</span>`;
            }
            
            // Delay 1.5 detik untuk menghindari rate limit
            await new Promise(r => setTimeout(r, 1500));
        }

        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStart').innerText = "Selesai!";
        goToTab(3);
    }

    function validateMetadata(data) {
        // Bersihkan keyword
        let kw = (typeof data.keywords === 'string' ? data.keywords.split(',') : data.keywords)
            .map(k => k.trim().toLowerCase().replace(/[^a-z ]/g, ''))
            .filter(k => k.length > 2 && !k.includes(' ')); // Hapus frase, ambil kata tunggal saja
        
        kw = [...new Set(kw)]; // Hapus duplikat

        // Isi jika kurang dari 50 kata (Fallback mechanism)
        const fillers = ["concept", "background", "design", "art", "illustration", "graphic", "vector", "digital", "modern", "creative", "style", "element", "abstract", "wallpaper", "pattern", "texture", "color", "colorful", "bright", "artistic"];
        let i = 0;
        while (kw.length < 50 && i < fillers.length) {
            if (!kw.includes(fillers[i])) kw.push(fillers[i]);
            i++;
        }

        return {
            title: data.title,
            description: data.description,
            keywords: kw.slice(0, 50).join(', ') // Pastikan max 50
        };
    }

    function renderResult(item, data) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div style="display:flex; gap:15px; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
                <img src="${item.preview}" class="img-mini">
                <strong>${item.file.name}</strong>
            </div>
            <span class="field-label">Title (${data.title.length} chars)</span>
            <div class="field-val">${data.title}</div>
            
            <span class="field-label">Description</span>
            <div class="field-val">${data.description}</div>
            
            <span class="field-label">Keywords (${data.keywords.split(',').length} words)</span>
            <div class="kw-box">${data.keywords}</div>
        `;
        document.getElementById('resultContainer').appendChild(div);
    }

    // --- RESET & EXPORT ---
    function resetAll() {
        queue = [];
        results = [];
        
        // Kosongkan UI
        document.getElementById('queueList').innerHTML = "";
        document.getElementById('resultContainer').innerHTML = "";
        document.getElementById('fileStatus').innerText = "";
        document.getElementById('btnNextToProcess').style.display = 'none';
        
        // Reset Input File agar bisa pilih file lagi
        const fileInput = document.getElementById('fileInput');
        fileInput.value = ""; 
        
        // Pindah ke Tab Upload
        goToTab(1);
    }

    function exportCSV() {
        if(results.length === 0) return alert("Belum ada data hasil!");
        
        let csvContent = "Filename,Title,Description,Keywords\n";
        results.forEach(row => {
            // Escape tanda kutip untuk format CSV yang valid
            const t = `"${row.title.replace(/"/g, '""')}"`;
            const d = `"${row.description.replace(/"/g, '""')}"`;
            const k = `"${row.keywords.replace(/"/g, '""')}"`;
            csvContent += `"${row.filename}",${t},${d},${k}\n`;
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `Metadata_Export_${new Date().getTime()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
