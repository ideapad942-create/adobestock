<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata V8.4 - Microstock US Pro</title>
    <style>
        :root { --primary: #2563eb; --success: #059669; --error: #dc2626; --dark: #1e293b; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 900px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        
        .tabs { display: flex; background: var(--dark); padding: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; border-radius: 6px; }
        .tab-btn.active { color: white; background: rgba(255,255,255,0.1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .content { padding: 30px; display: none; }
        .content.active { display: block; }

        .api-box { background: #eff6ff; border: 1px solid #bfdbfe; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .api-link { color: var(--primary); font-size: 13px; text-decoration: none; font-weight: bold; }

        .drop-zone { border: 2px dashed #cbd5e1; padding: 40px 20px; text-align: center; border-radius: 12px; cursor: pointer; background: #f1f5f9; }
        .drop-zone:hover { border-color: var(--primary); background: #e2e8f0; }

        .result-card { border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px; background: #fff; }
        .label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
        
        .copy-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start; }
        .box-text { flex-grow: 1; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 14px; color: #1e293b; line-height: 1.5; min-height: 20px; }
        
        .btn-copy { background: #e2e8f0; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap; transition: 0.2s; }
        .btn-copy:hover { background: #cbd5e1; }
        .btn-copy.copied { background: var(--success); color: white; }

        .btn-main { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; margin-top: 10px; }

        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .s-run { background: #dbeafe; color: #1e40af; }
        .s-done { background: #d1fae5; color: #065f46; }
        .s-limit { background: #ffedd5; color: #9a3412; }

        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .img-pre { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active">1. SETUP</button>
        <button class="tab-btn">2. UPLOAD</button>
        <button class="tab-btn">3. PROSES</button>
        <button class="tab-btn">4. HASIL</button>
    </div>

    <div class="content active" id="tab0">
        <div class="api-box">
            <h3 style="margin-top:0">üîë Groq API Key</h3>
            <input type="password" id="apiKey" placeholder="gsk_..." style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:6px; box-sizing:border-box;">
            <p style="margin: 10px 0 0;"><a href="https://console.groq.com/keys" target="_blank" class="api-link">Belum punya key? Generate gratis di sini ‚Üó</a></p>
        </div>
        <button class="btn-main btn-blue" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div class="content" id="tab1">
        <div class="drop-zone" id="dropArea">
            <span style="font-size:30px">üìÅ</span>
            <p><b>Klik atau Drag Gambar ke sini</b><br><span style="font-size:12px; color:#64748b">Support banyak file sekaligus</span></p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        </div>
        <div id="fileInfo" style="margin:15px 0; text-align:center; font-weight:bold; color:var(--success)"></div>
        <button class="btn-main btn-blue" id="btnToProses" style="display:none" onclick="changeTab(2)">Siap, Lanjut ke Proses ‚û°Ô∏è</button>
    </div>

    <div class="content" id="tab2">
        <button class="btn-main btn-blue" id="btnStart" onclick="startAI()">üöÄ Mulai Generate Metadata</button>
        <table id="queueTable"></table>
    </div>

    <div class="content" id="tab3">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn-main btn-green" style="margin-top:0" onclick="downloadCSV()">üì• Download CSV</button>
            <button class="btn-main btn-blue" style="margin-top:0; background:#64748b" onclick="location.reload()">üîÑ Reset</button>
        </div>
        <div id="finalResults"></div>
    </div>
</div>

<script>
    let filesData = [];
    let results = [];

    // --- SETUP LOGIC ---
    function saveKey() {
        const val = document.getElementById('apiKey').value.trim();
        if(val.startsWith('gsk_')) {
            localStorage.setItem('GROQ_KEY_V84', val);
            changeTab(1);
        } else alert("Masukkan API Key yang valid!");
    }
    if(localStorage.getItem('GROQ_KEY_V84')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY_V84');

    function changeTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    // --- UPLOAD LOGIC ---
    const dropArea = document.getElementById('dropArea');
    const fInput = document.getElementById('fileInput');

    dropArea.onclick = () => fInput.click();
    dropArea.ondragover = (e) => { e.preventDefault(); dropArea.style.borderColor = "var(--primary)"; };
    dropArea.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
    fInput.onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        for(let f of files) {
            const base64 = await toBase64(f);
            const preview = URL.createObjectURL(f);
            filesData.push({ id: filesData.length, name: f.name, base64: base64.split(',')[1], preview: preview, done: false });
            document.getElementById('queueTable').innerHTML += `
                <tr id="row-${filesData.length-1}">
                    <td><img src="${preview}" class="img-pre"></td>
                    <td>${f.name}</td>
                    <td id="st-${filesData.length-1}"><span class="status-badge">Ready</span></td>
                </tr>`;
        }
        document.getElementById('fileInfo').innerText = filesData.length + " File dipilih";
        document.getElementById('btnToProses').style.display = "block";
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // --- AI PROCESSING ---
    const SYSTEM_PROMPT = `You are a Microstock Metadata Expert for US Market (Shutterstock/Adobe Stock). 
Analyze the image as a VIDEO FOOTAGE frame.
REQUIREMENTS:
1. Title: Simple identification (e.g., "Cinematic clouds movement").
2. Description: 40-100 characters. Explain usage.
3. Keywords: Exactly 40 keywords. 
STRICT RULE: Only SINGLE words. Split phrases! "film burn" MUST be "film, burn". 
Output ONLY JSON: {"title": "...", "description": "...", "keywords": "word1, word2, word3..."}`;

    async function startAI() {
        const key = localStorage.getItem('GROQ_KEY_V84');
        const btn = document.getElementById('btnStart');
        btn.disabled = true;
        btn.innerText = "Sistem sedang bekerja...";

        for(let item of filesData) {
            if(item.done) continue;
            const statusBox = document.getElementById(`st-${item.id}`);
            statusBox.innerHTML = `<span class="status-badge s-run">Analisis...</span>`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.2-11b-vision-preview",
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [
                                { type: "text", text: "Identify this video footage:" },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }
                            ]}
                        ],
                        temperature: 0.2,
                        response_format: { type: "json_object" }
                    })
                });

                if(response.status === 429) {
                    statusBox.innerHTML = `<span class="status-badge s-limit">Limit Habis! Tunggu 60dtk</span>`;
                    await new Promise(r => setTimeout(r, 60000));
                    continue;
                }

                const data = await response.json();
                const cleanData = processData(JSON.parse(data.choices[0].message.content));
                results.push({ filename: item.name, ...cleanData });
                renderResult(item, cleanData);
                
                statusBox.innerHTML = `<span class="status-badge s-done">Selesai</span>`;
                item.done = true;
                await new Promise(r => setTimeout(r, 3000)); // Delay aman

            } catch (err) {
                statusBox.innerHTML = `<span class="status-badge" style="background:#fee2e2;color:#991b1b">Gagal</span>`;
            }
        }
        btn.disabled = false;
        btn.innerText = "Lanjutkan Proses";
        if(results.length === filesData.length) changeTab(3);
    }

    // --- LOGIC CLEANER (KUNCI DI SINI) ---
    function processData(raw) {
        // 1. Bersihkan Deskripsi (40-100 Karakter)
        let desc = raw.description;
        if(desc.length < 40) desc += " This high quality video footage is perfect for professional creative projects.";
        if(desc.length > 100) desc = desc.substring(0, 97) + "...";

        // 2. Bersihkan Keyword (Pecah Frase & Isi Otomatis)
        let kwRaw = raw.keywords.toLowerCase().replace(/,/g, ' ').replace(/[^\w\s]/gi, '');
        let kwArr = kwRaw.split(/\s+/).filter(w => w.length > 2);
        
        // Buang duplikat & kata terlarang
        const banned = ['image', 'photo', 'picture', 'jpg', 'vector', 'illustration'];
        kwArr = [...new Set(kwArr)].filter(w => !banned.includes(w));

        // Tambahkan filler jika kurang dari 39
        const fillers = ['footage', 'video', 'motion', 'loop', 'background', 'overlay', 'render', 'graphic', 'stock', 'media', 'creative', 'commercial', 'cinematic', 'high', 'quality', 'shot', 'real', 'natural', 'professional', 'effect', 'element', 'digital'];
        
        let i = 0;
        while(kwArr.length < 40 && i < fillers.length) {
            if(!kwArr.includes(fillers[i])) kwArr.push(fillers[i]);
            i++;
        }

        return {
            title: raw.title.substring(0, 70),
            description: desc,
            keywords: kwArr.slice(0, 42).join(', ')
        };
    }

    function renderResult(item, data) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <img src="${item.preview}" style="width:30px;height:30px;object-fit:cover;border-radius:30px;">
                <b style="font-size:13px">${item.name}</b>
            </div>
            
            <span class="label">Title (Simple ID)</span>
            <div class="copy-group">
                <div class="box-text" id="t-${item.id}">${data.title}</div>
                <button class="btn-copy" onclick="copyMe(this, 't-${item.id}')">Copy</button>
            </div>

            <span class="label">Description (40-100 Chars)</span>
            <div class="copy-group">
                <div class="box-text" id="d-${item.id}">${data.description}</div>
                <button class="btn-copy" onclick="copyMe(this, 'd-${item.id}')">Copy</button>
            </div>

            <span class="label">Keywords (Single Words: 39-42)</span>
            <div class="copy-group">
                <div class="box-text" id="k-${item.id}">${data.keywords}</div>
                <button class="btn-copy" onclick="copyMe(this, 'k-${item.id}')">Copy</button>
            </div>
        `;
        document.getElementById('finalResults').appendChild(div);
    }

    function copyMe(btn, id) {
        const text = document.getElementById(id).innerText;
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.innerText = "‚úì Copied";
        btn.classList.add('copied');
        setTimeout(() => { btn.innerText = "Copy"; btn.classList.remove('copied'); }, 1500);
    }

    function downloadCSV() {
        let csv = "Filename,Title,Description,Keywords\n";
        results.forEach(r => {
            csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.description.replace(/"/g,'""')}","${r.keywords}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Metadata_Microstock_Pro_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>
