<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metadata V7 - Drag, Drop & Paste Ready</title>
    <style>
        :root { --primary: #2563eb; --success: #059669; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 950px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 16px; border: none; background: none; color: #94a3b8; cursor: not-allowed; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { color: white; background: var(--primary); cursor: default; }

        .content { padding: 30px; display: none; }
        .content.active { display: block; }

        /* AREA UPLOAD DIPERBAIKI */
        .drop-zone { 
            border: 2px dashed #cbd5e1; 
            padding: 50px 20px; 
            text-align: center; 
            border-radius: 12px; 
            cursor: pointer; 
            background: #f8fafc; 
            transition: 0.3s; 
            position: relative;
        }
        .drop-zone:hover, .drop-zone.drag-over { 
            border-color: var(--primary); 
            background: #eff6ff; 
            transform: scale(1.01);
        }
        .drop-zone p { margin: 10px 0 0; color: #64748b; font-size: 14px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
        .img-mini { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .s-ready { background: #e2e8f0; color: #64748b; }
        .s-run { background: #dbeafe; color: #1e40af; animation: pulse 1s infinite; }
        .s-done { background: #d1fae5; color: #047857; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        .result-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px; }
        .field-label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-top: 15px; display: block; letter-spacing: 0.5px; }
        
        .copy-wrapper { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 5px; }
        .field-val { font-size: 14px; color: #1e293b; flex-grow: 1; font-family: 'Segoe UI', sans-serif; }
        
        .btn-copy { background: #cbd5e1; color: #1e293b; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .btn-copy:hover { background: #94a3b8; color: white; }
        .btn-copy.copied { background: var(--success); color: white; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 15px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-gray { background: #64748b; color: white; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="t0">1. API KEY</button>
        <button class="tab-btn" id="t1">2. UPLOAD</button>
        <button class="tab-btn" id="t2">3. PROSES</button>
        <button class="tab-btn" id="t3">4. HASIL</button>
    </div>

    <div id="c0" class="content active">
        <h2>üîë API Setup</h2>
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxx" style="width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px;">
        <button class="btn btn-blue" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="c1" class="content">
        <h2>üìÅ Smart Upload</h2>
        <div id="dropArea" class="drop-zone">
            <span style="font-size:32px;">üì•</span><br>
            <strong>Tarik File ke Sini</strong><br>
            <span style="font-size:12px; color:#64748b">atau <strong>CTRL+V</strong> untuk Paste Gambar</span>
            <p>Klik untuk Browse Manual</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="fileStatus" style="margin-top:15px; text-align:center; font-weight:bold; color:var(--success);"></div>
        <button class="btn btn-blue" id="btnNext" style="display:none;" onclick="goToTab(2)">Lanjut ke Proses AI ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <h2>‚ö° Hybrid AI Analysis</h2>
        <button class="btn btn-blue" id="btnStart" onclick="startProcessing()">üöÄ Mulai Generate</button>
        <table>
            <thead><tr><th>Preview</th><th>File</th><th>Status</th></tr></thead>
            <tbody id="queueList"></tbody>
        </table>
    </div>

    <div id="c3" class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <button class="btn btn-green" style="margin-top:0" onclick="exportCSV()">üì• Download CSV</button>
            <button class="btn btn-gray" style="margin-top:0" onclick="resetAll()">üîÑ Reset / Upload Lagi</button>
        </div>
        <div id="resultContainer"></div>
    </div>
</div>

<script>
    let queue = [];
    let results = [];
    const dropArea = document.getElementById('dropArea');

    // --- 1. FITUR DRAG & DROP & PASTE (PERBAIKAN UTAMA) ---
    
    // Mencegah default browser membuka gambar
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // Efek Visual saat Drag
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
    });

    // Handle File yang di-DROP
    dropArea.addEventListener('drop', (e) => {
        let dt = e.dataTransfer;
        let files = dt.files;
        handleFiles(files);
    });

    // Handle Klik Manual
    dropArea.addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    // Handle CTRL+V (PASTE)
    document.addEventListener('paste', (e) => {
        if(document.querySelector('.container').style.display === 'none') return;
        
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        const files = [];
        for (let index in items) {
            const item = items[index];
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                // Beri nama dummy karena paste tidak punya nama file asli
                const file = new File([blob], `pasted_image_${Date.now()}.png`, { type: blob.type });
                files.push(file);
            }
        }
        if(files.length > 0) {
            goToTab(1); // Pindah ke tab upload jika user paste
            handleFiles(files);
        }
    });

    // --- LOGIKA UTAMA (SAMA SEPERTI V6) ---

    const SYSTEM_PROMPT = `
    Role: Expert Microstock Metadata Specialist.
    Task: Analyze the image and generate metadata bridging "Visual Accuracy" and "Video Usage Potential".

    CRITICAL INSTRUCTIONS:
    1. TITLE (VISUAL HONESTY): 
       - Format: [Main Subject] + [Art Style]. 
       - Example: "Anime girl with long hair illustration", "Instagram logo vector icon".
       - **FORBIDDEN IN TITLE**: Do NOT use "footage", "video", "clip" unless it is a real camera recording.
    
    2. DESCRIPTION (USAGE CONTEXT): 
       - Describe visually first, then mention video utility.
       - Example: "Anime style illustration of a girl, suitable for use as a background in video animation projects or motion graphics."
    
    3. KEYWORDS (VIDEO SEO): 
       - STRICTLY SINGLE WORDS. Target: 39-41 words.
       - Must include video tags: animation, motion, loop, element, graphic, design, background, overlay.
       - Must include visual tags: anime, cartoon, illustration, vector (if applicable).
    
    Output JSON format: {"title": "...", "description": "...", "keywords": "word1, word2, ..."}
    `;

    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_KEY', k); goToTab(1); }
        else alert("API Key tidak valid!");
    }
    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    async function handleFiles(files) {
        if (files.length === 0) return;
        queue = [];
        const tbody = document.getElementById('queueList');
        tbody.innerHTML = "";
        document.getElementById('fileStatus').innerText = "Memproses gambar...";

        for (let i = 0; i < files.length; i++) {
            const compressed = await compressImage(files[i]);
            queue.push({ id: i, name: files[i].name, base64: compressed.data, preview: compressed.preview });
            tbody.innerHTML += `<tr><td><img src="${compressed.preview}" class="img-mini"></td><td>${files[i].name}</td><td id="status-${i}"><span class="status-badge s-ready">Ready</span></td></tr>`;
        }
        document.getElementById('fileStatus').innerText = `${files.length} Foto Siap!`;
        document.getElementById('btnNext').style.display = 'block';
    }

    function compressImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 512 / Math.max(img.width, img.height);
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve({ data: canvas.toDataURL('image/jpeg', 0.7).split(',')[1], preview: e.target.result });
                };
            };
        });
    }

    async function startProcessing() {
        const apiKey = localStorage.getItem('GROQ_KEY');
        if(!apiKey) return alert("API Key belum diset!");
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStart').innerText = "Sedang Memproses...";
        results = [];

        for (let item of queue) {
            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerHTML = `<span class="status-badge s-run">Analisis AI...</span>`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct",
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [
                                { type: "text", text: `Analyze this image: ${item.name}` },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }
                            ]}
                        ],
                        temperature: 0.1,
                        response_format: { type: "json_object" }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                const content = JSON.parse(data.choices[0].message.content);
                const validated = validateMetadata(content);
                
                results.push({ filename: item.name, ...validated });
                renderResult(item, validated);
                statusEl.innerHTML = `<span class="status-badge s-done">Sukses</span>`;
            } catch (err) {
                console.error(err);
                statusEl.innerHTML = `<span style="color:red; font-size:10px;">Error</span>`;
            }
            await new Promise(r => setTimeout(r, 1000));
        }
        document.getElementById('btnStart').disabled = false;
        document.getElementById('btnStart').innerText = "üöÄ Mulai Generate";
        goToTab(3);
    }

    function validateMetadata(data) {
        let kw = (typeof data.keywords === 'string' ? data.keywords : data.keywords.join(' '));
        kw = kw.toLowerCase().replace(/[^a-z0-9\s,]/g, '').replace(/[,\s]+/g, ' ').split(' ').map(k => k.trim()).filter(k => k.length > 2);
        kw = [...new Set(kw)];
        
        const required = ['animation', 'motion', 'loop', 'video', 'background', 'overlay', 'graphic', 'design', 'element'];
        required.forEach(t => { if(!kw.includes(t)) kw.push(t); });

        const fillers = ["creative", "modern", "art", "style", "concept", "digital", "web", "media", "internet", "technology"];
        let i = 0;
        while (kw.length < 39 && i < fillers.length) { if (!kw.includes(fillers[i])) kw.push(fillers[i]); i++; }
        if (kw.length > 41) kw = kw.slice(0, 41);

        return { title: data.title, description: data.description, keywords: kw.join(', ') };
    }

    function renderResult(item, data) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div style="display:flex; gap:15px; align-items:center; border-bottom:1px solid #f1f5f9; padding-bottom:15px; margin-bottom:15px;">
                <img src="${item.preview}" class="img-mini">
                <strong>${item.name}</strong>
            </div>
            
            <span class="field-label">Title</span>
            <div class="copy-wrapper">
                <div class="field-val" id="t-${item.id}">${data.title}</div>
                <button class="btn-copy" onclick="copyText(this, 't-${item.id}')">Copy</button>
            </div>

            <span class="field-label">Description</span>
            <div class="copy-wrapper">
                <div class="field-val" id="d-${item.id}">${data.description}</div>
                <button class="btn-copy" onclick="copyText(this, 'd-${item.id}')">Copy</button>
            </div>

            <span class="field-label">Keywords</span>
            <div class="copy-wrapper">
                <div class="field-val" id="k-${item.id}" style="font-size:12px;">${data.keywords}</div>
                <button class="btn-copy" onclick="copyText(this, 'k-${item.id}')">Copy</button>
            </div>
        `;
        document.getElementById('resultContainer').appendChild(div);
    }

    // --- 2. FUNGSI COPY UNIVERSAL (PERBAIKAN BUTTON) ---
    function copyText(btn, elementId) {
        const text = document.getElementById(elementId).innerText;
        
        // Cara Modern (Navigator API)
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => showCopied(btn))
            .catch(() => fallbackCopy(text, btn));
        } else {
            // Cara Klasik (Fallback untuk file lokal)
            fallbackCopy(text, btn);
        }
    }

    function fallbackCopy(text, btn) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // Hindari scroll
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopied(btn);
        } catch (err) {
            alert('Gagal copy otomatis. Silakan copy manual.');
        }
        document.body.removeChild(textArea);
    }

    function showCopied(btn) {
        const original = btn.innerText;
        btn.innerText = "Copied!";
        btn.classList.add('copied');
        setTimeout(() => {
            btn.innerText = original;
            btn.classList.remove('copied');
        }, 1500);
    }

    function resetAll() {
        queue = []; results = [];
        document.getElementById('queueList').innerHTML = "";
        document.getElementById('resultContainer').innerHTML = "";
        document.getElementById('fileStatus').innerText = "";
        document.getElementById('btnNext').style.display = 'none';
        document.getElementById('fileInput').value = "";
        goToTab(1);
    }

    function exportCSV() {
        if(results.length === 0) return alert("Data kosong!");
        let csv = "Filename,Title,Description,Keywords\n";
        results.forEach(r => {
            csv += `"${r.filename}","${r.title.replace(/"/g,'""')}","${r.description.replace(/"/g,'""')}","${r.keywords}"\n`;
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Metadata_V7_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>
