<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Microstock Metadata - Pro Batch</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --bg: #f1f5f9;
            --card: #ffffff;
            --dark: #0f172a;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 1000px; margin: auto; background: var(--card); border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Navigasi Tab */
        .tabs { display: flex; background: var(--dark); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: bold; white-space: nowrap; transition: 0.2s; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--primary); background: rgba(255,255,255,0.05); }

        .tab-content { padding: 30px; display: none; }
        .tab-content.active { display: block; }

        /* Step 1: Config */
        .api-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; }
        .link-groq { display: inline-block; margin-top: 10px; color: var(--primary); font-weight: 600; text-decoration: none; }
        .link-groq:hover { text-decoration: underline; }

        /* Step 2: Upload */
        .drop-zone { border: 3px dashed #cbd5e1; padding: 50px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--primary); background: #f8fafc; }

        /* Step 3: Process */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; }
        th { background: #f8fafc; font-size: 13px; text-transform: uppercase; color: #64748b; }
        .img-mini { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        
        /* Step 4: Output */
        .result-item { border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 15px; border-radius: 8px; }
        .copy-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .copy-btn { background: #64748b; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .copy-btn:hover { background: var(--dark); }

        /* Global Button */
        .main-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; margin-top: 10px; }
        .main-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .pending { background: #f1f5f9; color: #475569; }
        .loading { background: #dbeafe; color: #1e40af; animation: pulse 1.5s infinite; }
        .done { background: #dcfce7; color: #166534; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs" id="tabNavbar">
        <button class="tab-btn active" id="btn-tab0">1. SETUP API</button>
        <button class="tab-btn" id="btn-tab1">2. UPLOAD FOTO</button>
        <button class="tab-btn" id="btn-tab2">3. PROSES AI</button>
        <button class="tab-btn" id="btn-tab3">4. HASIL</button>
    </div>

    <div id="tab0" class="tab-content active">
        <h2>Konfigurasi Groq AI</h2>
        <div class="api-box">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">Masukkan Groq API Key:</label>
            <input type="password" id="apiKeyInput" placeholder="gsk_xxxxxxxxxxxx..." style="width:100%; padding:12px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
            <a href="https://console.groq.com/keys" target="_blank" class="link-groq">ðŸ‘‰ Belum punya API Key? Klik di sini untuk buat baru</a>
        </div>
        <button class="main-btn" onclick="saveApiKey()">Simpan API Key & Lanjut</button>
    </div>

    <div id="tab1" class="tab-content">
        <h2>Upload Batch Foto</h2>
        <p>Anda bisa memilih banyak file sekaligus.</p>
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <strong style="font-size:1.2rem; color:var(--primary);">+ Klik atau Seret Gambar</strong>
            <p>Mendukung JPG, PNG, WebP</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFileSelection(this.files)">
        </div>
        <div id="fileInfo" style="margin-top:20px; font-weight:bold; color:var(--success);"></div>
        <button id="nextToProcess" class="main-btn" style="display:none;" onclick="goToTab(2)">Lanjut ke Proses Identifikasi</button>
    </div>

    <div id="tab2" class="tab-content">
        <h2>Antrean Identifikasi AI</h2>
        <p>AI akan menganalisis objek tanpa istilah teknis (4K/UHD).</p>
        <button class="main-btn" id="startBtn" onclick="runBatch()">Mulai Generate Metadata</button>
        
        <table>
            <thead>
                <tr>
                    <th>Gambar</th>
                    <th>Nama File</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="queueTable"></tbody>
        </table>
    </div>

    <div id="tab3" class="tab-content">
        <h2>Metadata Berhasil Dibuat</h2>
        <p>Keyword sudah diformat kata tunggal (39-41 kata).</p>
        <div id="resultsContainer"></div>
        <button class="main-btn" style="background:#475569;" onclick="location.reload()">Reset & Ulangi</button>
    </div>
</div>

<script>
    let imageQueue = [];

    // Fungsi Navigasi Tab
    function goToTab(index) {
        document.querySelectorAll('.tab-content').forEach((content, i) => {
            content.classList.toggle('active', i === index);
        });
        document.querySelectorAll('.tab-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i === index);
        });
    }

    // Tab 1: Simpan API Key
    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (key.startsWith('gsk_')) {
            localStorage.setItem('my_groq_key', key);
            alert("âœ… Berhasil! API Key telah disimpan.");
            goToTab(1); // Pindah ke Tab Upload
        } else {
            alert("âŒ Maaf, API Key harus diawali dengan 'gsk_'. Silakan cek kembali.");
        }
    }

    // Load saved key on boot
    if(localStorage.getItem('my_groq_key')) {
        document.getElementById('apiKeyInput').value = localStorage.getItem('my_groq_key');
    }

    // Tab 2: Handle Upload
    function handleFileSelection(files) {
        imageQueue = [];
        const table = document.getElementById('queueTable');
        table.innerHTML = "";
        
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                imageQueue.push({
                    id: index,
                    name: file.name,
                    base64: e.target.result.split(',')[1],
                    preview: e.target.result,
                    status: 'pending'
                });
                
                table.innerHTML += `
                    <tr id="row-${index}">
                        <td><img src="${e.target.result}" class="img-mini"></td>
                        <td>${file.name}</td>
                        <td><span class="status-badge pending" id="status-${index}">Menunggu</span></td>
                    </tr>
                `;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('fileInfo').innerText = `âœ… ${files.length} Foto terpilih.`;
        document.getElementById('nextToProcess').style.display = "block";
    }

    // Tab 3: Core AI Logic
    async function runBatch() {
        const apiKey = localStorage.getItem('my_groq_key');
        if(!apiKey) return alert("API Key tidak ditemukan!");

        document.getElementById('startBtn').disabled = true;

        for (let img of imageQueue) {
            const statusEl = document.getElementById(`status-${img.id}`);
            statusEl.innerText = "Menganalisis...";
            statusEl.className = "status-badge loading";

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "llama-3.2-11b-vision-preview",
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: "Create Microstock Metadata. Return JSON with 'title' (60-80 chars), 'description' (150-200 chars), and 'keywords' (list of 60 single words, NO technical terms like 4k, uhd, resolution, focus on content/objects/mood)." },
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${img.base64}` } }
                            ]
                        }],
                        response_format: { type: "json_object" }
                    })
                });

                const rawData = await response.json();
                const result = JSON.parse(rawData.choices[0].message.content);
                const finalData = processMetadata(result);
                
                displayResult(img, finalData);
                
                statusEl.innerText = "Selesai";
                statusEl.className = "status-badge done";
            } catch (err) {
                statusEl.innerText = "Gagal";
                console.error(err);
            }
        }

        alert("Semua proses selesai!");
        goToTab(3);
    }

    // Clean & Format Data
    function processMetadata(data) {
        // Keyword cleaning: split multi-words, remove forbidden
        let words = data.keywords.toString().toLowerCase()
                        .replace(/4k|uhd|resolution|hd|camera|video/g, '')
                        .split(/[,\s]+/)
                        .filter(w => w.length > 2);
        
        words = [...new Set(words)]; // Unique

        // Ensure 39-41 count
        const fillers = ['background', 'concept', 'horizontal', 'outdoor', 'natural', 'view', 'composition', 'isolated', 'daylight', 'beautiful', 'scenery'];
        if (words.length > 40) {
            words = words.slice(0, 40);
        } else {
            while (words.length < 39) {
                let f = fillers[Math.floor(Math.random() * fillers.length)];
                if(!words.includes(f)) words.push(f);
            }
        }

        return {
            title: data.title,
            desc: data.description,
            keywords: words.join(', ')
        };
    }

    function displayResult(img, data) {
        const container = document.getElementById('resultsContainer');
        const count = data.keywords.split(',').length;
        
        container.innerHTML += `
            <div class="result-item">
                <div style="display:flex; gap:15px; align-items:center;">
                    <img src="${img.preview}" class="img-mini">
                    <strong>${img.name}</strong>
                </div>
                <div class="copy-group">
                    <div>
                        <small>TITLE:</small><br>
                        <strong>${data.title}</strong>
                        <button class="copy-btn" onclick="copy(this, '${data.title.replace(/'/g, "\\'")}')">Salin Judul</button>
                    </div>
                    <div>
                        <small>DESCRIPTION:</small><br>
                        <span>${data.desc}</span>
                        <button class="copy-btn" onclick="copy(this, '${data.desc.replace(/'/g, "\\'")}')">Salin Deskripsi</button>
                    </div>
                    <div>
                        <small>KEYWORDS (${count}):</small><br>
                        <span style="font-size:12px; color:#64748b;">${data.keywords}</span>
                        <button class="copy-btn" onclick="copy(this, '${data.keywords}')">Salin Keywords</button>
                    </div>
                </div>
            </div>
        `;
    }

    function copy(btn, text) {
        navigator.clipboard.writeText(text);
        const originalText = btn.innerText;
        btn.innerText = "âœ“ Tersalin!";
        btn.style.background = "#16a34a";
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.background = "#64748b";
        }, 2000);
    }
</script>

</body>
</html>
