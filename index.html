<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALES MIKIR - ADOBE STOCK OPTIMIZED</title>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --dark: #0f172a; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 900px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #94a3b8; cursor: not-allowed; font-weight: 600; transition: 0.3s; font-size: 13px; }
        .tab-btn.active { color: white; background: var(--primary); cursor: default; border-bottom: 4px solid #818cf8; }

        .content { padding: 30px; display: none; }
        .content.active { display: block; }

        .drop-zone { border: 2px dashed #cbd5e1; padding: 50px 20px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .drop-zone:hover { border-color: var(--primary); background: #fcfcff; }

        .result-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 25px; border-left: 5px solid var(--primary); }
        .field-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: 15px; display: block; }
        
        .copy-wrapper { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; margin-top: 5px; }
        .field-val { font-size: 13.5px; color: #1e293b; flex-grow: 1; line-height: 1.6; }
        
        .btn-copy { background: #e2e8f0; border: none; padding: 8px 16px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-copy.copied { background: var(--success); color: white; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 14px; }
        .btn-blue { background: var(--primary); color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 13px; }
        .img-mini { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; }
        
        .footer { text-align: center; margin-top: 25px; padding: 15px; font-size: 11px; color: #94a3b8; border-top: 1px solid #eee; }
        .males-mikir-msg { margin-top: 5px; font-style: italic; animation: pulse 3s infinite; color: var(--primary); font-weight: 600; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 9px; font-weight: bold; text-transform: uppercase; }
        .s-run { background: #e0e7ff; color: #4338ca; animation: blink 1s infinite; }
        .s-done { background: #d1fae5; color: #065f46; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="t0">1. API KEY</button>
        <button class="tab-btn" id="t1">2. UPLOAD</button>
        <button class="tab-btn" id="t2">3. PROSES</button>
        <button class="tab-btn" id="t3">4. HASIL</button>
    </div>

    <div id="c0" class="content active">
        <h2>üîë API Setup</h2>
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxx" style="width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:8px; box-sizing: border-box;">
        <p style="font-size:12px; color:#64748b; margin-top:8px;">
            Belum punya API KEY? <a href="https://console.groq.com/keys" target="_blank" style="color:var(--primary); font-weight:bold;">Generate di sini</a>
        </p>
        <button class="btn btn-blue" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="c1" class="content">
        <h2>üìÅ Upload Asset</h2>
        <div id="dropArea" class="drop-zone">
            <span style="font-size:35px;">üé¨</span><br>
            <strong>Drag & Drop Foto</strong>
            <p style="font-size:12px; color:#94a3b8;">Multiple upload didukung</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="fileStatus" style="margin-top:15px; text-align:center; font-weight:bold; color:var(--success);"></div>
        <button class="btn btn-blue" id="btnNext" style="display:none;" onclick="goToTab(2)">Generate Metadata ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <h2>‚ö° Video Processing </h2>
        <p style="font-size:11px; color:#64748b;">Memberikan jeda 2d agar AI maksimal membuat Title, Deskripsi & Keyword.</p>
        <button class="btn btn-blue" id="btnStart" onclick="startProcessing()">üöÄ Mulai Generate Metadata</button>
        <table>
            <thead><tr><th>Preview</th><th>File</th><th>Status</th></tr></thead>
            <tbody id="queueList"></tbody>
        </table>
    </div>

    <div id="c3" class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
            <button class="btn btn-blue" style="background:var(--success)" onclick="exportCSV()">üì• Download CSV</button>
            <button class="btn btn-blue" style="background:#64748b" onclick="resetAll()">üîÑ Reset / Upload Ulang</button>
        </div>
        <div id="resultContainer"></div>
    </div>

    <div class="footer">
        <strong>License Bang Jeyy</strong><br>
    </div>
</div>

<script>
    let queue = [];
    let results = [];
    const dropArea = document.getElementById('dropArea');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => {
        dropArea.addEventListener(n, (e) => { e.preventDefault(); e.stopPropagation(); });
    });
    dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
    dropArea.addEventListener('click', () => document.getElementById('fileInput').click());

    // --- SYSTEM PROMPT BARU: SESUAI LOGIKA ADOBE STOCK USER ---
    const SYSTEM_PROMPT = `
    Role: Professional Adobe Stock Metadata Specialist.
    Task: Analyze the image as a reference frame for a stock VIDEO FOOTAGE.

    STRICT GUIDELINES FOR OUTPUT:

    1. TITLE (PENTING!): 
       - Must be a natural, factual sentence. 
       - Structure: [Subject] [Action] [Specific Context/Location].
       - MAX LENGTH: 70 Characters (Strict limit).
       - DO NOT start with "A video of...", "Footage of...". Start directly with the subject.
       - DO NOT include technical specs in Title (No "4k", "HD", "Slow motion", "Close up").
       - Example: "Young asian woman jogging with golden retriever dog in city park".

    2. DESCRIPTION:
       - Expand the title. Tell a mini-story about the visual.
       - Include details: Mood, Lighting, Specific demographics (Ethnicity, Age), Props.
       - Length: 35-100 words.

    3. KEYWORDS:
       - Generate 50 raw keywords (we will filter them).
       - FOCUS ON: Specific object names, Species (e.g., "Jack Russell" not just "dog"), Cuisine names, Clothing types, Demographics (Race, Age), Emotions.
       - DO NOT USE: Brand names, Fictional characters, "In the style of", Dates.
       - SEPARATE with commas.

    Return ONLY JSON: {"title": "...", "description": "...", "keywords": "..."}
    `;

    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_V8_KEY', k); goToTab(1); } else alert("API Key Salah!");
    }
    if(localStorage.getItem('GROQ_V8_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_V8_KEY');

    async function handleFiles(files) {
        if (!files.length) return;
        for (let i = 0; i < files.length; i++) {
            const currentId = queue.length;
            const c = await compressImage(files[i]);
            queue.push({ id: currentId, name: files[i].name, base64: c.data, preview: c.preview, processed: false });
            document.getElementById('queueList').innerHTML += `<tr><td><img src="${c.preview}" class="img-mini"></td><td>${files[i].name}</td><td id="status-${currentId}"><span class="status-badge">Ready</span></td></tr>`;
        }
        document.getElementById('fileStatus').innerText = `${queue.length} File Siap!`;
        document.getElementById('btnNext').style.display = 'block';
    }

    function compressImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scl = 400 / Math.max(img.width, img.height);
                    cvs.width = img.width * scl; cvs.height = img.height * scl;
                    cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                    resolve({ data: cvs.toDataURL('image/jpeg', 0.6).split(',')[1], preview: e.target.result });
                };
            };
        });
    }

    async function startProcessing() {
        const k = localStorage.getItem('GROQ_V8_KEY');
        const btn = document.getElementById('btnStart');
        btn.disabled = true; btn.innerText = "HQ Processing...";

        for (let item of queue) {
            if (item.processed) continue;
            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerHTML = `<span class="status-badge s-run">Working...</span>`;
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct", 
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [{ type: "text", text: "Create Adobe Stock metadata for this video frame:" }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${item.base64}` } }] }
                        ], temperature: 0.1, response_format: { type: "json_object" }
                    })
                });
                const json = await res.json();
                
                if (json.error) throw new Error(json.error.message);

                const content = JSON.parse(json.choices[0].message.content);
                const finalData = cleanSEO(content);
                
                results.push({ filename: item.name, ...finalData });
                renderResult(item, finalData);
                statusEl.innerHTML = `<span class="status-badge s-done">DONE</span>`;
                item.processed = true;
            } catch (e) { 
                console.error(e);
                statusEl.innerHTML = `<span style="color:red; font-size:10px;">${e.message || "Error"}</span>`; 
            }
            
            await new Promise(r => setTimeout(r, 2000)); 
        }
        btn.disabled = false; btn.innerText = "üöÄ Mulai Generate"; goToTab(3);
    }

    // --- LOGIKA FILTER KEYWORD BARU: Min 39, Max 42 ---
    function cleanSEO(data) {
        // Kata yang dilarang keras di keywords
        const junk = ['and', 'the', 'with', 'for', 'from', 'this', 'that', 'into', 'upon', 'photo', 'image', 'picture', 'jpg', 'png', 'video', 'clip', 'footage'];
        // Kata teknis yang dilarang user di Judul/Keyword
        const banned = ['4k', '8k', 'hd', 'uhd', 'vector', 'illustration', 'eps', 'ai', 'generated', 'ai generated'];
        
        // Bersihkan keyword dari simbol aneh & lowercase
        let kw = data.keywords.toLowerCase().replace(/[^a-z0-9,\s]/g, '').split(',');
        
        // Filter: Hapus spasi berlebih, hapus kata banned, hapus kata pendek < 2 huruf
        let clean = kw.map(w => w.trim())
                      .filter(w => w.length > 2 && !junk.includes(w) && !banned.includes(w) && !/\d/.test(w)); // Hapus angka

        // Hilangkan duplikat
        clean = [...new Set(clean)];

        // LOGIKA PENGAMAN JUMLAH (Min 39 - Max 42)
        // Jika kebanyakan -> Potong jadi 42
        if (clean.length > 42) {
            clean = clean.slice(0, 42);
        }
        
        // Jika kurang dari 39 -> Tambah kata-kata aman (filler) yang relevan untuk video
        const safeFillers = ['lifestyle', 'people', 'person', 'activity', 'day', 'outdoor', 'indoor', 'scene', 'view', 'shot', 'moment', 'real', 'candid'];
        let fillerIdx = 0;
        while (clean.length < 39 && fillerIdx < safeFillers.length) {
            if (!clean.includes(safeFillers[fillerIdx])) {
                clean.push(safeFillers[fillerIdx]);
            }
            fillerIdx++;
        }

        return { 
            title: data.title.substring(0, 70), // Pastikan max 70 char sesuai request
            description: data.description, 
            keywords: clean.join(', ') // Output string koma
        };
    }

    function renderResult(item, data) {
        const kwCount = data.keywords.split(',').length;
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center; border-bottom:1px solid #eee; padding-bottom:5px;">
                <img src="${item.preview}" class="img-mini">
                <strong style="font-size:13px;">${item.name}</strong>
            </div>
            
            <span class="field-label">TITLE (Max 70 Chars)</span>
            <div class="copy-wrapper">
                <div class="field-val" id="t-${item.id}">${data.title}</div>
                <button class="btn-copy" onclick="copyText(this, 't-${item.id}')">Copy</button>
            </div>
            
            <span class="field-label">DESCRIPTION</span>
            <div class="copy-wrapper">
                <div class="field-val" id="d-${item.id}">${data.description}</div>
                <button class="btn-copy" onclick="copyText(this, 'd-${item.id}')">Copy</button>
            </div>
            
            <span class="field-label">KEYWORDS (Total: ${kwCount}) [Min 39 - Max 42]</span>
            <div class="copy-wrapper">
                <div class="field-val" id="k-${item.id}">${data.keywords}</div>
                <button class="btn-copy" onclick="copyText(this, 'k-${item.id}')">Copy</button>
            </div>
        `;
        document.getElementById('resultContainer').appendChild(div);
    }

    function copyText(btn, id) {
        const text = document.getElementById(id).innerText;
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed"; 
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand("copy"); 
            btn.innerText = "COPIED!";
            btn.classList.add('copied');
        } catch (err) {
            alert("Copy manual ya.");
        }
        
        document.body.removeChild(textarea); 
        setTimeout(() => { btn.innerText = "Copy"; btn.classList.remove('copied'); }, 1200);
    }

    function resetAll() {
        queue = []; results = [];
        document.getElementById('queueList').innerHTML = "";
        document.getElementById('resultContainer').innerHTML = "";
        document.getElementById('fileStatus').innerText = "";
        document.getElementById('btnNext').style.display = 'none';
        goToTab(1);
    }

    function exportCSV() {
        let csv = "Filename,Title,Description,Keywords\n";
        results.forEach(r => csv += `"${r.filename}","${r.title}","${r.description}","${r.keywords}"\n`);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
        a.download = `Metadata_Adobe_Stock_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>
